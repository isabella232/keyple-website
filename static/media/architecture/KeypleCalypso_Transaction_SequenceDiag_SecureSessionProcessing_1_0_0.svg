<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1560" height="3617" contentScriptType="application/ecmascript" contentStyleType="text/css" style="width:1560px;height:3617px" preserveAspectRatio="none" version="1.1" viewBox="0 0 1560 3617" zoomAndPan="magnify"><g><rect style="stroke:#000;stroke-width:2" width="282" height="139.758" x="13" y="524.531" fill="#FFF"/><rect style="stroke:#000;stroke-width:2" width="278.5" height="200.461" x="13" y="1486.484" fill="#FFF"/><rect style="stroke:#000;stroke-width:2" width="335.5" height="172.461" x="1203" y="2475.789" fill="#FFF"/><rect style="stroke:#000;stroke-width:2" width="335.5" height="172.461" x="1203" y="2662.25" fill="#FFF"/><rect style="stroke:#000;stroke-width:2" width="278.5" height="139.758" x="13" y="3035.523" fill="#FFF"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="38" x2="38" y1="83.609" y2="3605.555"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="238.5" x2="238.5" y1="83.609" y2="3605.555"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="362" x2="362" y1="83.609" y2="3605.555"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="864" x2="864" y1="83.609" y2="3605.555"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="1260" x2="1260" y1="83.609" y2="3605.555"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="1510.5" x2="1510.5" y1="83.609" y2="3605.555"/><text x="25" y="80.533" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="20">PO</text><ellipse cx="38" cy="13" fill="#FEFECE" rx="8" ry="8" style="stroke:#a80036;stroke-width:2"/><path fill="none" d="M38,21 L38,48 M25,29 L51,29 M38,48 L25,63 M38,48 L51,63" style="stroke:#a80036;stroke-width:2"/><rect style="stroke:#a80036;stroke-width:1.5" width="85" height="31.609" x="196.5" y="51" fill="#FEFECE"/><text x="203.5" y="72.533" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71">PO Reader</text><rect style="stroke:#a80036;stroke-width:1.5" width="82" height="49.219" x="321" y="33.391" fill="#FEFECE"/><text x="333.5" y="54.924" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57">Ticketing</text><text x="328" y="72.533" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68">application</text><rect style="stroke:#a80036;stroke-width:1.5" width="114" height="49.219" x="807" y="33.391" fill="#FEFECE"/><text x="815" y="54.924" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98">Keyple Calypso</text><text x="814" y="72.533" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100">Transaction API</text><rect style="stroke:#a80036;stroke-width:1.5" width="94" height="31.609" x="1213" y="51" fill="#FEFECE"/><text x="1220" y="72.533" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80">SAM Reader</text><text x="1493.5" y="80.533" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29">SAM</text><ellipse cx="1511" cy="13" fill="#FEFECE" rx="8" ry="8" style="stroke:#a80036;stroke-width:2"/><path fill="none" d="M1511,21 L1511,48 M1498,29 L1524,29 M1511,48 L1498,63 M1511,48 L1524,63" style="stroke:#a80036;stroke-width:2"/><rect style="stroke:#eee;stroke-width:1" width="1545.5" height="3" x="3" y="114.785" fill="#EEE"/><line style="stroke:#000;stroke-width:1" x1="3" x2="1548.5" y1="114.785" y2="114.785"/><line style="stroke:#000;stroke-width:1" x1="3" x2="1548.5" y1="117.785" y2="117.785"/><rect style="stroke:#000;stroke-width:2" width="124" height="24.352" x="713.75" y="103.609" fill="#EEE"/><text x="719.75" y="121.105" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106">PO Identification</text><polygon fill="#A80036" points="852 156.313 862 160.313 852 164.313 856 160.313" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="160.313" y2="160.313"/><text x="369" y="155.456" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454">new PoSelectionRequest(new PoSelector(SpecificAid, InvalidatedPo.REJECT))</text><polygon fill="#A80036" points="852 186.664 862 190.664 852 194.664 856 190.664" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="190.664" y2="190.664"/><text x="369" y="185.808" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="185.808" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177">ReadRecord(SFI_Environment)</text><polygon fill="#A80036" points="852 217.016 862 221.016 852 225.016 856 221.016" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="221.016" y2="221.016"/><text x="369" y="216.159" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="216.159" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183">ReadRecord(SFI_ContractsList)</text><polygon fill="#A80036" points="852 247.367 862 251.367 852 255.367 856 251.367" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="251.367" y2="251.367"/><text x="369" y="246.511" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="246.511" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81">CardSelection</text><polygon fill="#A80036" points="852 277.719 862 281.719 852 285.719 856 281.719" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="281.719" y2="281.719"/><text x="369" y="276.862" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48">process</text><text x="421" y="276.862" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169">ExplicitSelection(PO Reader)</text><polygon fill="#00F" points="250 324.422 240 328.422 250 332.422 246 328.422" style="stroke:#00f;stroke-width:1"/><line style="stroke:#00f;stroke-width:1" x1="244" x2="863" y1="328.422" y2="328.422"/><text x="256" y="307.214" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95">PO 1: transmits</text><text x="355" y="307.214" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413">SelectionRequest(PoSelector, ApduCommands[ReadRecord(SFI_Env)],</text><text x="256" y="323.565" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110">keep PO Channel)</text><polygon fill="#A80036" points="49 354.773 39 358.773 49 362.773 45 358.773" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="358.773" y2="358.773"/><text x="55" y="353.917" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109">Open card channel</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="389.125" y2="385.125"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="389.125" y2="393.125"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="389.125" y2="389.125"/><text x="45" y="384.269" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="49 415.477 39 419.477 49 423.477 45 419.477" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="419.477" y2="419.477"/><text x="55" y="414.62" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101">SelectApplication</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="449.828" y2="445.828"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="449.828" y2="453.828"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="449.828" y2="449.828"/><text x="45" y="444.972" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43">PO FCI</text><line style="stroke:#a80036;stroke-width:1" x1="239" x2="281" y1="496.531" y2="496.531"/><line style="stroke:#a80036;stroke-width:1" x1="281" x2="281" y1="496.531" y2="509.531"/><line style="stroke:#a80036;stroke-width:1" x1="240" x2="281" y1="509.531" y2="509.531"/><polygon fill="#A80036" points="250 505.531 240 509.531 250 513.531 246 509.531" style="stroke:#a80036;stroke-width:1"/><text x="246" y="475.323" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109">checks invalidation</text><text x="246" y="491.675" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36">status</text><path fill="#EEE" d="M13,524.5313 L290,524.5313 L290,532.5313 L280,542.5313 L13,542.5313 L13,524.5313" style="stroke:#000;stroke-width:1"/><rect style="stroke:#000;stroke-width:2" width="282" height="139.758" x="13" y="524.531" fill="none"/><text x="28" y="539.026" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="232">PO APDU commands outside session</text><polygon fill="#A80036" points="49 561.234 39 565.234 49 569.234 45 565.234" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="565.234" y2="565.234"/><text x="55" y="560.378" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127">ReadRecord(SFI_Env)</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="595.586" y2="591.586"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="595.586" y2="599.586"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="595.586" y2="595.586"/><text x="45" y="590.73" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71">Env EF data</text><polygon fill="#A80036" points="49 621.938 39 625.938 49 629.938 45 625.938" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="625.938" y2="625.938"/><text x="55" y="621.081" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136">ReadRecord(SFI_CList)</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="656.289" y2="652.289"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="656.289" y2="660.289"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="656.289" y2="656.289"/><text x="45" y="651.433" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80">CList EF data</text><line style="stroke:#00f;stroke-width:1" x1="862" x2="852" y1="693.641" y2="689.641"/><line style="stroke:#00f;stroke-width:1" x1="862" x2="852" y1="693.641" y2="697.641"/><line style="stroke:#00f;stroke-width:1;stroke-dasharray:2,2" x1="239" x2="863" y1="693.641" y2="693.641"/><text x="246" y="688.784" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43">replies</text><text x="293" y="688.784" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="445">SelectionResponse(SelectionStatus(PO FCI), ApduResponses[Env EF data])</text><line style="stroke:#a80036;stroke-width:1" x1="864" x2="906" y1="740.344" y2="740.344"/><line style="stroke:#a80036;stroke-width:1" x1="906" x2="906" y1="740.344" y2="753.344"/><line style="stroke:#a80036;stroke-width:1" x1="865" x2="906" y1="753.344" y2="753.344"/><polygon fill="#A80036" points="875 749.344 865 753.344 875 757.344 871 753.344" style="stroke:#a80036;stroke-width:1"/><text x="871" y="719.136" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131">Calypso card identified</text><text x="871" y="735.487" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200">(PO type, serial, revision, features)</text><line style="stroke:#a80036;stroke-width:1" x1="864" x2="906" y1="800.047" y2="800.047"/><line style="stroke:#a80036;stroke-width:1" x1="906" x2="906" y1="800.047" y2="813.047"/><line style="stroke:#a80036;stroke-width:1" x1="865" x2="906" y1="813.047" y2="813.047"/><polygon fill="#A80036" points="875 809.047 865 813.047 875 817.047 871 813.047" style="stroke:#a80036;stroke-width:1"/><text x="871" y="778.839" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109">Card validity check</text><text x="871" y="795.19" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240">(black listed serial, HCE token expiration)</text><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="843.398" y2="839.398"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="843.398" y2="847.398"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="362" x2="863" y1="843.398" y2="843.398"/><text x="379" y="838.542" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166">Calypso card image: PoCard</text><polygon fill="#A80036" points="852 869.75 862 873.75 852 877.75 856 873.75" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="873.75" y2="873.75"/><text x="369" y="868.894" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181">PoCard.getEfFileData(SFI_Env)</text><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="904.102" y2="900.102"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="904.102" y2="908.102"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="362" x2="863" y1="904.102" y2="904.102"/><text x="379" y="899.245" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107">Environment bytes</text><polygon fill="#A80036" points="852 930.453 862 934.453 852 938.453 856 934.453" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="934.453" y2="934.453"/><text x="369" y="929.597" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190">PoCard.getEfFileData(SFI_CList)</text><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="964.805" y2="960.805"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="964.805" y2="968.805"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="362" x2="863" y1="964.805" y2="964.805"/><text x="379" y="959.948" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113">ContractsList bytes</text><rect style="stroke:#eee;stroke-width:1" width="1545.5" height="3" x="3" y="993.981" fill="#EEE"/><line style="stroke:#000;stroke-width:1" x1="3" x2="1548.5" y1="993.981" y2="993.981"/><line style="stroke:#000;stroke-width:1" x1="3" x2="1548.5" y1="996.981" y2="996.981"/><rect style="stroke:#000;stroke-width:2" width="139" height="24.352" x="706.25" y="982.805" fill="#EEE"/><text x="712.25" y="1000.3" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121">PO Secure Session</text><polygon fill="#A80036" points="852 1051.859 862 1055.859 852 1059.859 856 1055.859" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="1055.859" y2="1055.859"/><text x="369" y="1034.651" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380">new PoTransaction({PoReader, PoCard}, {SamReader, SamCard},</text><text x="369" y="1051.003" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136">SessionMode.ATOMIC)</text><polygon fill="#A80036" points="852 1082.211 862 1086.211 852 1090.211 856 1086.211" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="1086.211" y2="1086.211"/><text x="369" y="1081.354" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="1081.354" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177">ReadRecord(SFI_Environment)</text><polygon fill="#A80036" points="852 1112.563 862 1116.563 852 1120.563 856 1116.563" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="1116.563" y2="1116.563"/><text x="369" y="1111.706" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="1111.706" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162">ReadRecord(SFI_Contract1)</text><polygon fill="#A80036" points="852 1142.914 862 1146.914 852 1150.914 856 1146.914" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="1146.914" y2="1146.914"/><text x="369" y="1142.058" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="1142.058" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162">ReadCounter(SFI_Counter1)</text><polygon fill="#A80036" points="852 1173.266 862 1177.266 852 1181.266 856 1177.266" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="1177.266" y2="1177.266"/><text x="369" y="1172.409" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48">process</text><text x="421" y="1172.409" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135">Opening(PO_DebitKey)</text><polygon fill="#0F0" points="1248 1236.32 1258 1240.32 1248 1244.32 1252 1240.32" style="stroke:#0f0;stroke-width:1"/><line style="stroke:#0f0;stroke-width:1" x1="864" x2="1254" y1="1240.32" y2="1240.32"/><text x="871" y="1202.761" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105">SAM 1: transmits</text><text x="980" y="1202.761" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179">CardRequest(ApduCommands[</text><text x="871" y="1219.112" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253">SelectDiversifier(PO_Serial), GetChallenge],</text><text x="871" y="1235.464" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120">keep SAM Channel)</text><polygon fill="#A80036" points="1499 1266.672 1509 1270.672 1499 1274.672 1503 1270.672" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="1270.672" y2="1270.672"/><text x="1267" y="1265.815" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92">SelectDiversifier</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="1301.023" y2="1297.023"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="1301.023" y2="1305.023"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="1301.023" y2="1301.023"/><text x="1277" y="1296.167" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="1499 1327.375 1509 1331.375 1499 1335.375 1503 1331.375" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="1331.375" y2="1331.375"/><text x="1267" y="1326.519" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78">GetChallenge</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="1361.727" y2="1357.727"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="1361.727" y2="1365.727"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="1361.727" y2="1361.727"/><text x="1277" y="1356.87" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88">SAM challenge</text><line style="stroke:#0f0;stroke-width:1" x1="864" x2="874" y1="1408.43" y2="1404.43"/><line style="stroke:#0f0;stroke-width:1" x1="864" x2="874" y1="1408.43" y2="1412.43"/><line style="stroke:#0f0;stroke-width:1;stroke-dasharray:2,2" x1="864" x2="1259" y1="1408.43" y2="1408.43"/><text x="881" y="1387.222" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43">replies</text><text x="928" y="1387.222" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213">CardResponse(ApduResponses[ack,</text><text x="881" y="1403.573" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96">SAM challenge])</text><polygon fill="#00F" points="250 1467.484 240 1471.484 250 1475.484 246 1471.484" style="stroke:#00f;stroke-width:1"/><line style="stroke:#00f;stroke-width:1" x1="244" x2="863" y1="1471.484" y2="1471.484"/><text x="256" y="1433.925" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95">PO 2: transmits</text><text x="355" y="1433.925" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344">CardRequest(ApduCommands[OpenSession(PO_DebitKey,</text><text x="256" y="1450.276" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="532">SAM challenge,SFI_Env to read), ReadRecord(SFI_Contract1, ReadCounter(SFI_Counter1)],</text><text x="256" y="1466.628" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120">keep SAM Channel)</text><path fill="#EEE" d="M13,1486.4844 L282,1486.4844 L282,1494.4844 L272,1504.4844 L13,1504.4844 L13,1486.4844" style="stroke:#000;stroke-width:1"/><rect style="stroke:#000;stroke-width:2" width="278.5" height="200.461" x="13" y="1486.484" fill="none"/><text x="28" y="1500.979" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224">PO APDU commands inside session</text><polygon fill="#A80036" points="49 1523.188 39 1527.188 49 1531.188 45 1527.188" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="1527.188" y2="1527.188"/><text x="55" y="1522.331" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78">OpenSession</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="1557.539" y2="1553.539"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="1557.539" y2="1561.539"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="1557.539" y2="1557.539"/><text x="45" y="1552.683" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157">PO challenge, Env EF data</text><polygon fill="#A80036" points="49 1583.891 39 1587.891 49 1591.891 45 1587.891" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="1587.891" y2="1587.891"/><text x="55" y="1583.034" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71">ReadRecord</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="1618.242" y2="1614.242"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="1618.242" y2="1622.242"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="1618.242" y2="1618.242"/><text x="45" y="1613.386" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106">Contract1 EF data</text><polygon fill="#A80036" points="49 1644.594 39 1648.594 49 1652.594 45 1648.594" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="1648.594" y2="1648.594"/><text x="55" y="1643.737" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75">ReadCounter</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="1678.945" y2="1674.945"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="1678.945" y2="1682.945"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="1678.945" y2="1678.945"/><text x="45" y="1674.089" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102">Counter1 EF data</text><line style="stroke:#00f;stroke-width:1" x1="862" x2="852" y1="1732.648" y2="1728.648"/><line style="stroke:#00f;stroke-width:1" x1="862" x2="852" y1="1732.648" y2="1736.648"/><line style="stroke:#00f;stroke-width:1;stroke-dasharray:2,2" x1="239" x2="863" y1="1732.648" y2="1732.648"/><text x="246" y="1711.44" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43">replies</text><text x="293" y="1711.44" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382">CardResponse(ApduResponses[Open response with Env EF data,</text><text x="246" y="1727.792" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231">Contracts1 EF data, Counter1 EF data])</text><line style="stroke:#a80036;stroke-width:1" x1="864" x2="906" y1="1779.352" y2="1779.352"/><line style="stroke:#a80036;stroke-width:1" x1="906" x2="906" y1="1779.352" y2="1792.352"/><line style="stroke:#a80036;stroke-width:1" x1="865" x2="906" y1="1792.352" y2="1792.352"/><polygon fill="#A80036" points="875 1788.352 865 1792.352 875 1796.352 871 1792.352" style="stroke:#a80036;stroke-width:1"/><text x="871" y="1758.144" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165">Card responses consistency</text><text x="871" y="1774.495" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190">(avoid injection command attack)</text><line style="stroke:#a80036;stroke-width:1" x1="864" x2="906" y1="1839.055" y2="1839.055"/><line style="stroke:#a80036;stroke-width:1" x1="906" x2="906" y1="1839.055" y2="1852.055"/><line style="stroke:#a80036;stroke-width:1" x1="865" x2="906" y1="1852.055" y2="1852.055"/><polygon fill="#A80036" points="875 1848.055 865 1852.055 875 1856.055 871 1852.055" style="stroke:#a80036;stroke-width:1"/><text x="871" y="1817.847" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144">Card session commands</text><text x="871" y="1834.198" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269">memorized in cache (SAM digest not updated)</text><line style="stroke:#a80036;stroke-width:1" x1="864" x2="906" y1="1882.406" y2="1882.406"/><line style="stroke:#a80036;stroke-width:1" x1="906" x2="906" y1="1882.406" y2="1895.406"/><line style="stroke:#a80036;stroke-width:1" x1="865" x2="906" y1="1895.406" y2="1895.406"/><polygon fill="#A80036" points="875 1891.406 865 1895.406 875 1899.406 871 1895.406" style="stroke:#a80036;stroke-width:1"/><text x="871" y="1877.55" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143">Ratification status check</text><line style="stroke:#a80036;stroke-width:1" x1="864" x2="906" y1="1958.461" y2="1958.461"/><line style="stroke:#a80036;stroke-width:1" x1="906" x2="906" y1="1958.461" y2="1971.461"/><line style="stroke:#a80036;stroke-width:1" x1="865" x2="906" y1="1971.461" y2="1971.461"/><polygon fill="#A80036" points="875 1967.461 865 1971.461 875 1975.461 871 1971.461" style="stroke:#a80036;stroke-width:1"/><text x="871" y="1920.901" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109">Card image update</text><text x="871" y="1937.253" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138">data consistency check</text><text x="871" y="1953.604" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204">(Env read outside &amp; inside session)</text><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="2001.813" y2="1997.813"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="2001.813" y2="2005.813"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="362" x2="863" y1="2001.813" y2="2001.813"/><text x="379" y="1996.956" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="852 2028.164 862 2032.164 852 2036.164 856 2032.164" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="2032.164" y2="2032.164"/><text x="369" y="2027.308" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216">PoCard.getEfFileData(SFI_Contract1)</text><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="2062.516" y2="2058.516"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="2062.516" y2="2066.516"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="362" x2="863" y1="2062.516" y2="2062.516"/><text x="379" y="2057.659" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92">Contract1 bytes</text><polygon fill="#A80036" points="852 2088.867 862 2092.867 852 2096.867 856 2092.867" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="2092.867" y2="2092.867"/><text x="369" y="2088.011" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212">PoCard.getEfFileData(SFI_Counter1)</text><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="2123.219" y2="2119.219"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="2123.219" y2="2127.219"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="362" x2="863" y1="2123.219" y2="2123.219"/><text x="379" y="2118.362" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85">Counter1 value</text><polygon fill="#A80036" points="852 2149.57 862 2153.57 852 2157.57 856 2153.57" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="2153.57" y2="2153.57"/><text x="369" y="2148.714" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="2148.714" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216">UpdateRecord(SFI_Event, EventData)</text><polygon fill="#A80036" points="852 2179.922 862 2183.922 852 2187.922 856 2183.922" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="2183.922" y2="2183.922"/><text x="369" y="2179.065" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="2179.065" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297">DecreaseCounter(SFI_Counter1, ValueToDecrease)</text><polygon fill="#A80036" points="852 2210.273 862 2214.273 852 2218.273 856 2214.273" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="2214.273" y2="2214.273"/><text x="369" y="2209.417" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50">prepare</text><text x="423" y="2209.417" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97">releaseChannel()</text><polygon fill="#A80036" points="852 2240.625 862 2244.625 852 2248.625 856 2244.625" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="858" y1="2244.625" y2="2244.625"/><text x="369" y="2239.769" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48">process</text><text x="421" y="2239.769" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118">Closing(Not Ratified)</text><line style="stroke:#a80036;stroke-width:1" x1="864" x2="906" y1="2291.328" y2="2291.328"/><line style="stroke:#a80036;stroke-width:1" x1="906" x2="906" y1="2291.328" y2="2304.328"/><line style="stroke:#a80036;stroke-width:1" x1="865" x2="906" y1="2304.328" y2="2304.328"/><polygon fill="#A80036" points="875 2300.328 865 2304.328 875 2308.328 871 2304.328" style="stroke:#a80036;stroke-width:1"/><text x="871" y="2270.12" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233">Anticipation of the future card responses</text><text x="871" y="2286.472" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163">update of the session cache</text><polygon fill="#0F0" points="1248 2396.086 1258 2400.086 1248 2404.086 1252 2400.086" style="stroke:#0f0;stroke-width:1"/><line style="stroke:#0f0;stroke-width:1" x1="864" x2="1254" y1="2400.086" y2="2400.086"/><text x="871" y="2329.823" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105">SAM 2: transmits</text><text x="980" y="2329.823" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179">CardRequest(ApduCommands[</text><text x="871" y="2346.175" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308">DigestInit(PO_OpenResponse), DigestUpdateMultiple</text><text x="871" y="2362.526" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266">, DigestUpdateMultiple, DigestUpdateMultiple,</text><text x="871" y="2378.878" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209">DigestUpdateMultiple, DigestClose],</text><text x="871" y="2395.229" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120">keep SAM Channel)</text><polygon fill="#A80036" points="1499 2426.438 1509 2430.438 1499 2434.438 1503 2430.438" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="2430.438" y2="2430.438"/><text x="1267" y="2425.581" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54">DigestInit</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2460.789" y2="2456.789"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2460.789" y2="2464.789"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="2460.789" y2="2460.789"/><text x="1277" y="2455.933" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><path fill="#EEE" d="M1203,2475.7891 L1399,2475.7891 L1399,2483.7891 L1389,2493.7891 L1203,2493.7891 L1203,2475.7891" style="stroke:#000;stroke-width:1"/><rect style="stroke:#000;stroke-width:2" width="335.5" height="172.461" x="1203" y="2475.789" fill="none"/><text x="1218" y="2490.284" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151">&apos;n&apos; session MAC updates</text><polygon fill="#A80036" points="1499 2528.844 1509 2532.844 1499 2536.844 1503 2532.844" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="2532.844" y2="2532.844"/><text x="1267" y="2511.636" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198">DigestUpdateMultiple(ReadRecord</text><text x="1267" y="2527.987" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106">cmd &amp; responses)</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2563.195" y2="2559.195"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2563.195" y2="2567.195"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="2563.195" y2="2563.195"/><text x="1277" y="2558.339" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="1499 2605.898 1509 2609.898 1499 2613.898 1503 2609.898" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="2609.898" y2="2609.898"/><text x="1267" y="2588.69" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205">DigestUpdateMplutiple(ReadRecord</text><text x="1267" y="2605.042" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106">cmd &amp; responses)</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2640.25" y2="2636.25"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2640.25" y2="2644.25"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="2640.25" y2="2640.25"/><text x="1277" y="2635.394" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><path fill="#EEE" d="M1203,2662.25 L1418,2662.25 L1418,2670.25 L1408,2680.25 L1203,2680.25 L1203,2662.25" style="stroke:#000;stroke-width:1"/><rect style="stroke:#000;stroke-width:2" width="335.5" height="172.461" x="1203" y="2662.25" fill="none"/><text x="1218" y="2676.745" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170">&apos;2 * z&apos; session MAC updates</text><polygon fill="#A80036" points="1499 2715.305 1509 2719.305 1499 2723.305 1503 2719.305" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="2719.305" y2="2719.305"/><text x="1267" y="2698.097" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209">DigestUpdateMultiple(UpdateRecord</text><text x="1267" y="2714.448" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38">cmd &amp;</text><text x="1309" y="2714.448" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71">anticipated</text><text x="1384" y="2714.448" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57">response)</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2749.656" y2="2745.656"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2749.656" y2="2753.656"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="2749.656" y2="2749.656"/><text x="1277" y="2744.8" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="1499 2792.359 1509 2796.359 1499 2800.359 1503 2796.359" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="2796.359" y2="2796.359"/><text x="1267" y="2775.151" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227">DigestUpdateMultiple(DecreaseCounter</text><text x="1267" y="2791.503" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38">cmd &amp;</text><text x="1309" y="2791.503" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71">anticipated</text><text x="1384" y="2791.503" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57">response)</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2826.711" y2="2822.711"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2826.711" y2="2830.711"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="2826.711" y2="2826.711"/><text x="1277" y="2821.854" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="1499 2860.063 1509 2864.063 1499 2868.063 1503 2864.063" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="2864.063" y2="2864.063"/><text x="1267" y="2859.206" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70">DigestClose</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2894.414" y2="2890.414"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="2894.414" y2="2898.414"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="2894.414" y2="2894.414"/><text x="1277" y="2889.558" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89">SAM certificate</text><line style="stroke:#0f0;stroke-width:1" x1="864" x2="874" y1="2957.469" y2="2953.469"/><line style="stroke:#0f0;stroke-width:1" x1="864" x2="874" y1="2957.469" y2="2961.469"/><line style="stroke:#0f0;stroke-width:1;stroke-dasharray:2,2" x1="864" x2="1259" y1="2957.469" y2="2957.469"/><text x="881" y="2919.909" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43">replies</text><text x="928" y="2919.909" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286">CardResponse(ApduResponses[DigestInit status,</text><text x="881" y="2936.261" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123">DigestUpdateMultiple</text><text x="1004" y="2936.261" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="6">s</text><text x="1014" y="2936.261" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168">status], DigestClose reponse</text><text x="881" y="2952.612" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120">with SAM certificate)</text><polygon fill="#00F" points="250 3016.523 240 3020.523 250 3024.523 246 3020.523" style="stroke:#00f;stroke-width:1"/><line style="stroke:#00f;stroke-width:1" x1="244" x2="863" y1="3020.523" y2="3020.523"/><text x="256" y="2982.964" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95">PO 3: transmits</text><text x="355" y="2982.964" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="502">CardRequest(ApduCommands[UpdateRecord(SFI_Event), DecreaseCounter(decValue),</text><text x="256" y="2999.315" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308">CloseSession(SamCertificate),RatificationCommand],</text><text x="256" y="3015.667" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120">keep SAM Channel)</text><path fill="#EEE" d="M13,3035.5234 L282,3035.5234 L282,3043.5234 L272,3053.5234 L13,3053.5234 L13,3035.5234" style="stroke:#000;stroke-width:1"/><rect style="stroke:#000;stroke-width:2" width="278.5" height="139.758" x="13" y="3035.523" fill="none"/><text x="28" y="3050.019" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224">PO APDU commands inside session</text><polygon fill="#A80036" points="49 3072.227 39 3076.227 49 3080.227 45 3076.227" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="3076.227" y2="3076.227"/><text x="55" y="3071.37" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82">UpdateRecord</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3106.578" y2="3102.578"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3106.578" y2="3110.578"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="3106.578" y2="3106.578"/><text x="45" y="3101.722" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="49 3132.93 39 3136.93 49 3140.93 45 3136.93" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="3136.93" y2="3136.93"/><text x="55" y="3132.073" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100">DecreaseCounter</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3167.281" y2="3163.281"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3167.281" y2="3171.281"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="3167.281" y2="3167.281"/><text x="45" y="3162.425" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103">new counter value</text><polygon fill="#A80036" points="49 3200.633 39 3204.633 49 3208.633 45 3204.633" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="3204.633" y2="3204.633"/><text x="55" y="3199.776" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177">CloseSession(SAM certificate)</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3234.984" y2="3230.984"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3234.984" y2="3238.984"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="3234.984" y2="3234.984"/><text x="45" y="3230.128" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79">PO certificate</text><polygon fill="#A80036" points="49 3261.336 39 3265.336 49 3269.336 45 3265.336" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="3265.336" y2="3265.336"/><text x="55" y="3260.479" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64">Ratification</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3295.688" y2="3291.688"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3295.688" y2="3299.688"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="3295.688" y2="3295.688"/><text x="45" y="3290.831" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><polygon fill="#A80036" points="49 3322.039 39 3326.039 49 3330.039 45 3326.039" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="43" x2="238" y1="3326.039" y2="3326.039"/><text x="55" y="3321.183" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111">Close card channel</text><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3356.391" y2="3352.391"/><line style="stroke:#a80036;stroke-width:1" x1="237" x2="227" y1="3356.391" y2="3360.391"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="38" x2="238" y1="3356.391" y2="3356.391"/><text x="45" y="3351.534" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text><line style="stroke:#00f;stroke-width:1" x1="862" x2="852" y1="3403.094" y2="3399.094"/><line style="stroke:#00f;stroke-width:1" x1="862" x2="852" y1="3403.094" y2="3407.094"/><line style="stroke:#00f;stroke-width:1;stroke-dasharray:2,2" x1="239" x2="863" y1="3403.094" y2="3403.094"/><text x="246" y="3381.886" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43">replies</text><text x="293" y="3381.886" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314">CardResponse(ApduResponses[UpdateReoord status,</text><text x="246" y="3398.237" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441">new Counter1 value, PO certificate, Ratification ack], ChannelStatus.Closed)</text><polygon fill="#0F0" points="1248 3462.148 1258 3466.148 1248 3470.148 1252 3466.148" style="stroke:#0f0;stroke-width:1"/><line style="stroke:#0f0;stroke-width:1" x1="864" x2="1254" y1="3466.148" y2="3466.148"/><text x="871" y="3428.589" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105">SAM 3: transmits</text><text x="980" y="3428.589" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179">CardRequest(ApduCommands[</text><text x="871" y="3444.94" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220">External Authenticate(PO certificate)],</text><text x="871" y="3461.292" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120">keep SAM Channel)</text><polygon fill="#A80036" points="1499 3492.5 1509 3496.5 1499 3500.5 1503 3496.5" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1505" y1="3496.5" y2="3496.5"/><text x="1267" y="3491.644" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121">ExternalAuthenticate</text><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="3526.852" y2="3522.852"/><line style="stroke:#a80036;stroke-width:1" x1="1260" x2="1270" y1="3526.852" y2="3530.852"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="1260" x2="1510" y1="3526.852" y2="3526.852"/><text x="1277" y="3521.995" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121">authentication status</text><line style="stroke:#0f0;stroke-width:1" x1="864" x2="874" y1="3557.203" y2="3553.203"/><line style="stroke:#0f0;stroke-width:1" x1="864" x2="874" y1="3557.203" y2="3561.203"/><line style="stroke:#0f0;stroke-width:1;stroke-dasharray:2,2" x1="864" x2="1259" y1="3557.203" y2="3557.203"/><text x="881" y="3552.347" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43">replies</text><text x="928" y="3552.347" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325">CardResponse(ApduResponses[Authentification status])</text><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="3587.555" y2="3583.555"/><line style="stroke:#a80036;stroke-width:1" x1="362" x2="372" y1="3587.555" y2="3591.555"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2" x1="362" x2="863" y1="3587.555" y2="3587.555"/><text x="379" y="3582.698" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21">ack</text></g></svg>